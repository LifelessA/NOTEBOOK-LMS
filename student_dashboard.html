<!DOCTYPE html>
<html>
<head>
    <title>Student Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-color: #1e1e1e;
            --cell-bg: #2d2d2d;
            --border-color: #3a3a3a;
            --primary-color: #007acc;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: #d4d4d4;
            margin: 0;
            padding: 2rem;
        }
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .container {
            display: flex;
            gap: 2rem;
        }
        .panel {
            background: var(--cell-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            flex: 1;
        }
        button {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #005a9e; }
        .list { list-style: none; padding: 0; }
        .list li {
            background: #333;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .list li a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }
        .list li a:hover { text-decoration: underline; }
        .list li small { color: #aaa; margin-left: 10px; }
        
        #logout-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: #c82333;
        }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: #aaa; }
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 1rem;
            box-sizing: border-box;
            min-height: 80px;
        }
        #ticket-list .ticket-status {
            font-style: italic;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        #ticket-list .ticket-status.open { background-color: #28a745; color: white; }
        #ticket-list .ticket-status.closed { background-color: #6c757d; color: white; }
        #msg { margin-top: 1rem; display: none; }
        #msg.success { color: #4CAF50; }
        #msg.error { color: #ff5555; }
    </style>
</head>
<body>
    <a href="/logout"><button id="logout-btn">Logout</button></a>
    <h1>Student Dashboard</h1>
    
    <div class="container">
        <div class="panel">
            <h2>New Assignments</h2>
            <ul id="assignments-list" class="list">
                </ul>
        </div>
        <div class="panel">
            <h2>My Submissions</h2>
            <ul id="submissions-list" class="list">
                </ul>
        </div>
    </div>

    <div class="container" style="margin-top: 2rem;">
        <div class="panel">
            <h2>Support Tickets</h2>
            <form id="ticket-form">
                <div class="input-group">
                    <label for="query_text">Request a change or report an issue</label>
                    <textarea id="query_text" required></textarea>
                </div>
                <button type="submit">Submit Ticket</button>
            </form>
            <p id="msg"></p>
            <h3 style="margin-top: 2rem;">My Tickets</h3>
            <ul id="ticket-list" class="list"></ul>
        </div>
    </div>

    <script>
        const assignmentsList = document.getElementById('assignments-list');
        const submissionsList = document.getElementById('submissions-list');
        const ticketList = document.getElementById('ticket-list');
        const msgEl = document.getElementById('msg');

        async function loadAssignments() {
            const response = await fetch('/api/student/assignments');
            if (response.ok) {
                const assignments = await response.json();
                assignmentsList.innerHTML = '';
                if (assignments.length === 0) {
                    assignmentsList.innerHTML = '<li>No new assignments. Good job!</li>';
                    return;
                }
                assignments.forEach(a => {
                    assignmentsList.innerHTML += `
                        <li>
                            <a href="/?assignment_id=${a.id}">${a.title}</a>
                            <small>from ${a.teacher_name}</small>
                        </li>
                    `;
                });
            }
        }

        async function loadSubmissions() {
            const response = await fetch('/api/student/submissions');
            if (response.ok) {
                const submissions = await response.json();
                submissionsList.innerHTML = '';
                if (submissions.length === 0) {
                    submissionsList.innerHTML = '<li>No submissions yet.</li>';
                    return;
                }
                submissions.forEach(s => {
                    submissionsList.innerHTML += `
                        <li>
                            <a href="/?submission_id=${s.id}" target="_blank">Review: ${s.title}</a>
                            <small>Submitted: ${new Date(s.submitted_at).toLocaleString()}</small>
                        </li>
                    `;
                });
            }
        }

        async function loadTickets() {
            const response = await fetch('/api/ticket/my_tickets');
            if (!response.ok) return;
            const tickets = await response.json();
            ticketList.innerHTML = '';
            tickets.forEach(ticket => {
                const resolvedDate = ticket.resolved_at ? `Resolved: ${new Date(ticket.resolved_at).toLocaleString()}` : '';
                ticketList.innerHTML += `
                    <li style="cursor: default;">
                        <div>
                            <p>${ticket.query_text}</p>
                            <small>Created: ${new Date(ticket.created_at).toLocaleString()}</small>
                            <small style="margin-left: 1rem;">${resolvedDate}</small>
                        </div>
                        <span class="ticket-status ${ticket.status}">${ticket.status}</span>
                    </li>
                `;
            });
        }

        document.getElementById('ticket-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query_text = document.getElementById('query_text').value;
            const response = await fetch('/api/ticket/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query_text })
            });
            const data = await response.json();
            msgEl.textContent = data.message;
            msgEl.style.display = 'block';
            if (response.ok) {
                msgEl.className = 'success';
                document.getElementById('ticket-form').reset();
                loadTickets();
            } else {
                msgEl.className = 'error';
            }
        });

        loadAssignments();
        loadSubmissions();
        loadTickets();
    </script>
</body>
</html>